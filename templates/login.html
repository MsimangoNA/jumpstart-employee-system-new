<!DOCTYPE html>
<html>
<head>
    <title>JESS - Login</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 400px; margin: 100px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 8px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 15px; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .message { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .user-info { background: #e2e3e5; padding: 15px; margin: 20px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h2>JESS Employee Login</h2>
    
    <div id="login-form">
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="email" required>
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="password" required>
        </div>
        <button onclick="login()">Login</button>
        <p><a href="#" onclick="showRegister()">Don't have an account? Register</a></p>
    </div>

    <div id="register-form" class="hidden">
        <h3>Employee Registration</h3>
        <div class="form-group">
            <label>Full Name:</label>
            <input type="text" id="reg-name" required>
        </div>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="reg-email" required>
        </div>
        <div class="form-group">
            <label>Employee ID:</label>
            <input type="text" id="reg-employee-id" required>
        </div>
        <div class="form-group">
            <label>Department:</label>
            <input type="text" id="reg-department">
        </div>
        <div class="form-group">
            <label>Password:</label>
            <input type="password" id="reg-password" required minlength="6">
        </div>
        <button onclick="register()">Register</button>
        <p><a href="#" onclick="showLogin()">Already have an account? Login</a></p>
    </div>

    <div id="message"></div>
    
    <div id="user-info" class="user-info hidden">
        <h3>Welcome to JESS!</h3>
        <div id="user-details"></div>
        <button onclick="fetchProtectedData()">Test Protected API</button>
        <button onclick="fetchUserProfile()">Get My Profile</button>
        <button onclick="logout()" style="background: #dc3545;">Logout</button>
    </div>

    <div id="protected-data" class="hidden"></div>

    <script>
        // Supabase configuration
        const supabaseUrl = '{{'https://hdzdxwssctktnlxsalws.supabase.co' }}';
        const supabaseKey = '{{  process.env.SUPABASE_KEY }}';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentUser = null;
        let currentSession = null;

        // Check for existing session on page load
        checkSession();

        async function checkSession() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (session) {
                currentSession = session;
                currentUser = session.user;
                showUserInfo(currentUser);
                showProtectedUI();
            }
        }

        // Auth state listener
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state changed:', event);
            
            if (event === 'SIGNED_IN' && session) {
                currentSession = session;
                currentUser = session.user;
                showUserInfo(currentUser);
                showProtectedUI();
                showMessage('Login successful!', 'success');
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                currentSession = null;
                hideProtectedUI();
                showMessage('Logged out successfully', 'success');
            }
        });

        // Login function
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            if (error) {
                showMessage('Login failed: ' + error.message, 'error');
            } else {
                showMessage('Login successful!', 'success');
            }
        }

        // Register function
        async function register() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const employeeId = document.getElementById('reg-employee-id').value;
            const department = document.getElementById('reg-department').value;
            const password = document.getElementById('reg-password').value;

            try {
                const response = await fetch('/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        full_name: name,
                        email: email,
                        employee_id: employeeId,
                        department: department,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('Registration successful! Please check your email for verification.', 'success');
                    showLogin();
                } else {
                    showMessage('Registration failed: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('Registration error: ' + error.message, 'error');
            }
        }

        // Logout function
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                showMessage('Error signing out: ' + error.message, 'error');
            }
        }

        // Fetch protected data from our Flask API
        async function fetchProtectedData() {
            if (!currentSession) {
                showMessage('Not authenticated', 'error');
                return;
            }

            try {
                const token = currentSession.access_token;
                const response = await fetch('/auth/protected', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const data = await response.json();
                document.getElementById('protected-data').innerHTML = 
                    '<h4>Protected API Response:</h4><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                document.getElementById('protected-data').classList.remove('hidden');
            } catch (error) {
                showMessage('Error fetching protected data: ' + error.message, 'error');
            }
        }

        // Fetch user profile from our API
        async function fetchUserProfile() {
            if (!currentSession) {
                showMessage('Not authenticated', 'error');
                return;
            }

            try {
                const token = currentSession.access_token;
                const response = await fetch('/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('user-details').innerHTML = 
                        '<p><strong>Name:</strong> ' + data.user.full_name + '</p>' +
                        '<p><strong>Email:</strong> ' + data.user.email + '</p>' +
                        '<p><strong>Employee ID:</strong> ' + data.user.employee_id + '</p>' +
                        '<p><strong>Department:</strong> ' + data.user.department + '</p>' +
                        '<p><strong>Role:</strong> ' + data.user.role + '</p>';
                } else {
                    showMessage('Error fetching profile: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('Error fetching profile: ' + error.message, 'error');
            }
        }

        // UI helper functions
        function showUserInfo(user) {
            document.getElementById('user-details').innerHTML = 
                `<p><strong>Email:</strong> ${user.email}</p>
                 <p><strong>Status:</strong> Loading profile...</p>`;
        }

        function showProtectedUI() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
        }

        function hideProtectedUI() {
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('protected-data').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        function showRegister() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>